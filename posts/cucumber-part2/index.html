<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>cucumber and testcontainers | codecrumbs</title><meta name=keywords content="testing,integration-testing,cucumber,testcontainers,kafka"><meta name=description content="Part 2 of 4 on Integration Testing with Cucumber - adding Testcontainers."><meta name=author content><link rel=canonical href=https://www.codecrumbs.dev/posts/cucumber-part2/><link href=/assets/css/stylesheet.min.a3a4a544d77bf8494a9ee749e1cce7323262765c649cbb4149fc00e26abd147f.css integrity="sha256-o6SlRNd7+ElKnudJ4cznMjJidlxknLtBSfwA4mq9FH8=" rel="preload stylesheet" as=style><link rel=icon href=https://www.codecrumbs.dev/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.codecrumbs.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.codecrumbs.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://www.codecrumbs.dev/apple-touch-icon.png><link rel=mask-icon href=https://www.codecrumbs.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><meta property="og:title" content="cucumber and testcontainers"><meta property="og:description" content="Part 2 of 4 on Integration Testing with Cucumber - adding Testcontainers."><meta property="og:type" content="article"><meta property="og:url" content="https://www.codecrumbs.dev/posts/cucumber-part2/"><meta property="article:published_time" content="2021-03-09T19:36:28+00:00"><meta property="article:modified_time" content="2021-03-09T19:36:28+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="cucumber and testcontainers"><meta name=twitter:description content="Part 2 of 4 on Integration Testing with Cucumber - adding Testcontainers."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"cucumber and testcontainers","name":"cucumber and testcontainers","description":"I recently wrote an integration test framework for a Kafka pipeline using Cucumber and Testcontainers. This is part 2 of a series explaining how, in which we\u0026amp;rsquo;ll start Kafka …","keywords":["testing","integration-testing","cucumber","testcontainers","kafka"],"articleBody":"I recently wrote an integration test framework for a Kafka pipeline using Cucumber and Testcontainers. This is part 2 of a series explaining how, in which we’ll start Kafka using the Testcontainers library.\nPart 1 is here if you want to see how to set up Cucumber to run tests from Maven \u0026 your IDE.\nwhat is testcontainers? I’ll cover Testcontainers more fully in a separate post some time but, for now, we just need to know that Testcontainers is a rather amazing library for starting infrastructure such as databases or messaging systems in Docker containers at test-time. In fact, it can be used to start anything that can run in a container. The library manages the lifecycle of those containers shutting them down cleanly on test completion.\nWe’ll need to add two Testcontainers dependencies to our pom to use it - org.testcontainers:testcontainers and org.testcontainers:kafka.\ncucumber lifecycle hooks Starting containers takes a little time so we want to share the containers between our Cucumber scenarios. When using Testcontainers with JUnit Jupiter this is easy using the annotations @Testcontainers and @Container. When the latter is applied to a static field, Testcontainers will start containers \u0026 share them amongst our JUnit @Test methods.\nCucumber does have its own @Before annotation triggered before each scenario but it does not have the @BeforeAll1 we’d ideally like to cleanly implement container sharing.\npipeline plugin I looked at a couple of options to overcome the lack of an appropriate hook but settled on a solution that used Cucumber’s Plugin mechanism. This allows us to listen to Cucumber lifecycle events and start our containers exactly once.\nMy initial plugin looks like this:\npublic class IngestionPipeline implements EventListener { private KafkaContainer kafkaContainer; private final EventHandlerTestRunStarted startUp = new EventHandler() { private static final String CONFLUENT_VERSION = \"6.0.1\"; @Override public void receive(TestRunStarted testRunStarted) { kafkaContainer = new KafkaContainer( DockerImageName.parse(\"confluentinc/cp-kafka\") .withTag(CONFLUENT_VERSION) ).withLogConsumer( new Slf4jLogConsumer( LoggerFactory.getLogger(\"kafka-container\") ).withSeparateOutputStreams() ); kafkaContainer.start(); } }; private final EventHandlerTestRunFinished shutDown = new EventHandler() { @Override public void receive(TestRunFinished testRunFinished) { kafkaContainer.stop(); } }; @Override public void setEventPublisher(EventPublisher publisher) { publisher.registerHandlerFor(TestRunStarted.class, startUp); publisher.registerHandlerFor(TestRunFinished.class, shutDown); } } What is going on here?\n We are registering two listeners - startUp to be notified of TestRunStarted events \u0026 shutDown to be notified of TestRunFinished events. In the first of these, we are creating \u0026 starting a Docker container running Kafka (the image we are using actually includes Zookeeper too). We are doing this using the Testcontainers class KafkaContainer.2 We are attaching a logger to the container to capture and log its output. By using withSeparateOutputStreams() Testcontainers will split the stderr \u0026 stdout output of the container and log them at ERROR \u0026 INFO levels respectively. In shutDown we are stopping the container.  To get Cucumber to recognise \u0026 use this plugin, we need to add the fully qualified class name to cucumber.properties and junit-platform.properties.\nrun it! Assuming we already have Docker installed, if we now run our tests, we’ll see the Docker image being downloaded (this is a one-time activity) and the container starting.\nWe just started a Kafka instance with only a few lines of code! Next time we’ll introduce our application \u0026 start that too.\ntestcontainers.\ncucumber.\ncucumber-jvm.\nsource3.\n  See this issue for a discussion of workarounds. ↩︎\n In addition to its GenericContainer that can be used to start just about anything in a container , Testcontainers provides a handful of technology-specific classes like KafkaContainer where they add some useful functionality over and above the GenericContainer. ↩︎\n The repository is tagged at 1.1 to indicate the version of it that goes with this part of the series. ↩︎\n   ","wordCount":"600","inLanguage":"en","datePublished":"2021-03-09T19:36:28Z","dateModified":"2021-03-09T19:36:28Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.codecrumbs.dev/posts/cucumber-part2/"},"publisher":{"@type":"Organization","name":"codecrumbs","logo":{"@type":"ImageObject","url":"https://www.codecrumbs.dev/images/favicon.ico"}}}</script></head><body class=dark id=top><script>if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://www.codecrumbs.dev accesskey=h title="codecrumbs (Alt + H)"><img src=/images/profile.png alt=logo aria-label=logo height=50px>codecrumbs</a>
<span class=logo-switches><span class=theme-toggle title="(Alt + T)"><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://www.codecrumbs.dev/tags/ title=tags><span>tags</span></a></li><li><a href=https://www.codecrumbs.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.codecrumbs.dev/about title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>cucumber and testcontainers</h1><div class=post-description>Part 2 of 4 on Integration Testing with Cucumber - adding Testcontainers.</div><div class=post-meta>March 9, 2021&nbsp;·&nbsp;3 min</div></header><div class=post-content><p>I recently wrote an integration test framework for a Kafka pipeline using Cucumber and Testcontainers. This is part 2
of a series explaining how, in which we&rsquo;ll start Kafka using the Testcontainers library.</p><p>Part 1 is <a href=https://www.codecrumbs.dev/posts/cucumber-part1/ title="cucumber set up">here</a> if you want to see how to set up Cucumber to
run tests from Maven & your IDE.</p><h3 id=what-is-testcontainers>what is testcontainers?<a hidden class=anchor aria-hidden=true href=#what-is-testcontainers>#</a></h3><p>I&rsquo;ll cover Testcontainers more fully in a separate post some time but, for now, we just need to know that Testcontainers is a rather amazing
library for starting infrastructure such as databases or messaging systems in Docker containers at test-time.
In fact, it can be used to start <em>anything</em> that can run in a container. The library manages the lifecycle of those containers shutting them
down cleanly on test completion.</p><p>We&rsquo;ll need to add two Testcontainers dependencies to our pom to use it - <code>org.testcontainers:testcontainers</code> and <code>org.testcontainers:kafka</code>.</p><h3 id=cucumber-lifecycle-hooks>cucumber lifecycle hooks<a hidden class=anchor aria-hidden=true href=#cucumber-lifecycle-hooks>#</a></h3><p>Starting containers takes a little time so we want to share the containers between our Cucumber scenarios. When using Testcontainers with JUnit
Jupiter this is easy using the annotations <code>@Testcontainers</code> and <code>@Container</code>. When the latter is applied to a static field, Testcontainers will
start containers & share them amongst our JUnit <code>@Test</code> methods.</p><p>Cucumber does have its own <code>@Before</code> annotation triggered before each scenario but it does not have the <code>@BeforeAll</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> we&rsquo;d ideally like to
cleanly implement container sharing.</p><h3 id=pipeline-plugin>pipeline plugin<a hidden class=anchor aria-hidden=true href=#pipeline-plugin>#</a></h3><p>I looked at a couple of options to overcome the lack of an appropriate hook but settled on a solution that used Cucumber&rsquo;s Plugin mechanism. This allows us to listen to Cucumber lifecycle
events and start our containers exactly once.</p><p>My initial plugin looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IngestionPipeline</span> <span style=color:#66d9ef>implements</span> EventListener <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>private</span> KafkaContainer kafkaContainer<span style=color:#f92672>;</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EventHandler<span style=color:#f92672>&lt;</span>TestRunStarted<span style=color:#f92672>&gt;</span> startUp <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EventHandler<span style=color:#f92672>&lt;&gt;()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String CONFLUENT_VERSION <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;6.0.1&#34;</span><span style=color:#f92672>;</span>

        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>receive</span><span style=color:#f92672>(</span>TestRunStarted testRunStarted<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            kafkaContainer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> KafkaContainer<span style=color:#f92672>(</span>
                    DockerImageName<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;confluentinc/cp-kafka&#34;</span><span style=color:#f92672>)</span>
                            <span style=color:#f92672>.</span><span style=color:#a6e22e>withTag</span><span style=color:#f92672>(</span>CONFLUENT_VERSION<span style=color:#f92672>)</span>
            <span style=color:#f92672>).</span><span style=color:#a6e22e>withLogConsumer</span><span style=color:#f92672>(</span>
                    <span style=color:#66d9ef>new</span> Slf4jLogConsumer<span style=color:#f92672>(</span>
                            LoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;kafka-container&#34;</span><span style=color:#f92672>)</span>
                    <span style=color:#f92672>).</span><span style=color:#a6e22e>withSeparateOutputStreams</span><span style=color:#f92672>()</span>
            <span style=color:#f92672>);</span>
            kafkaContainer<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>};</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EventHandler<span style=color:#f92672>&lt;</span>TestRunFinished<span style=color:#f92672>&gt;</span> shutDown <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EventHandler<span style=color:#f92672>&lt;&gt;()</span> <span style=color:#f92672>{</span>
        <span style=color:#a6e22e>@Override</span>
        <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>receive</span><span style=color:#f92672>(</span>TestRunFinished testRunFinished<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            kafkaContainer<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>};</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setEventPublisher</span><span style=color:#f92672>(</span>EventPublisher publisher<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        publisher<span style=color:#f92672>.</span><span style=color:#a6e22e>registerHandlerFor</span><span style=color:#f92672>(</span>TestRunStarted<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> startUp<span style=color:#f92672>);</span>
        publisher<span style=color:#f92672>.</span><span style=color:#a6e22e>registerHandlerFor</span><span style=color:#f92672>(</span>TestRunFinished<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> shutDown<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>What is going on here?</p><ul><li>We are registering two listeners - <code>startUp</code> to be notified of <code>TestRunStarted</code> events & <code>shutDown</code> to be notified of
<code>TestRunFinished</code> events.</li><li>In the first of these, we are creating & starting a Docker container running Kafka (the image we are using actually includes Zookeeper too).
We are doing this using the Testcontainers class <code>KafkaContainer</code>.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li><li>We are attaching a logger to the container to capture and log its output. By using <code>withSeparateOutputStreams()</code> Testcontainers will
split the stderr & stdout output of the container and log them at <code>ERROR</code> & <code>INFO</code> levels respectively.</li><li>In <code>shutDown</code> we are stopping the container.</li></ul><p>To get Cucumber to recognise & use this plugin, we need to add the fully qualified class name to <code>cucumber.properties</code> and <code>junit-platform.properties</code>.</p><h3 id=run-it>run it!<a hidden class=anchor aria-hidden=true href=#run-it>#</a></h3><p>Assuming we already have Docker installed, if we now run our tests, we&rsquo;ll see the Docker image being downloaded (this is
a one-time activity) and the container starting.</p><p>We just started a Kafka instance with only a few lines of code! Next time we&rsquo;ll introduce our application & start that too.</p><p><a href=https://www.testcontainers.org/>testcontainers</a>.<br><a href=https://cucumber.io/tools/cucumber-open/>cucumber</a>.<br><a href=https://github.com/cucumber/cucumber-jvm>cucumber-jvm</a>.<br><a href=https://github.com/codecrumbs-dev/cucumber-integration/releases/tag/cucumber-integration-1.1>source</a><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>See <a href=https://github.com/cucumber/cucumber-jvm/issues/515>this</a> issue for a discussion of workarounds. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>In addition to its <code>GenericContainer</code> that can be used to start just about anything in a container , Testcontainers provides a
handful of technology-specific classes like <code>KafkaContainer</code> where they add some useful functionality over and above the <code>GenericContainer</code>. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>The repository is tagged at 1.1 to indicate the version of it that goes with this part of the series. <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.codecrumbs.dev/tags/testing/>testing</a></li><li><a href=https://www.codecrumbs.dev/tags/integration-testing/>integration-testing</a></li><li><a href=https://www.codecrumbs.dev/tags/cucumber/>cucumber</a></li><li><a href=https://www.codecrumbs.dev/tags/testcontainers/>testcontainers</a></li><li><a href=https://www.codecrumbs.dev/tags/kafka/>kafka</a></li></ul></footer></article></main><footer class=footer><span>&#183;</span>
<span>&copy; 2021 <a href=https://www.codecrumbs.dev>codecrumbs</a></span>
<span>&#183;</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});if(id==="top"){history.replaceState(null,null," ");}else{history.replaceState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>