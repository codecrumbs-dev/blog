<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>integration testing bdd-style | codecrumbs</title><meta name=keywords content="testing,integration-testing,cucumber,testcontainers,bdd,kafka"><meta name=description content="Testing a Kafka Pipeline with Cucumber & Testcontainers."><meta name=author content><link rel=canonical href=https://www.codecrumbs.dev/posts/cucumber-integration-tests/><link href=/assets/css/stylesheet.min.2e395db2bdab9bc6e1029ec3e859688ff138e0a326a873a09b710ec69e792341.css integrity="sha256-Ljldsr2rm8bhAp7D6Floj/E44KMmqHOgm3EOxp55I0E=" rel="preload stylesheet" as=style><link rel=icon href=https://www.codecrumbs.dev/images/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.codecrumbs.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.codecrumbs.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://www.codecrumbs.dev/apple-touch-icon.png><link rel=mask-icon href=https://www.codecrumbs.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.80.0"><meta property="og:title" content="integration testing bdd-style"><meta property="og:description" content="Testing a Kafka Pipeline with Cucumber & Testcontainers."><meta property="og:type" content="article"><meta property="og:url" content="https://www.codecrumbs.dev/posts/cucumber-integration-tests/"><meta property="article:published_time" content="2021-05-08T17:22:00+00:00"><meta property="article:modified_time" content="2021-05-08T17:22:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="integration testing bdd-style"><meta name=twitter:description content="Testing a Kafka Pipeline with Cucumber & Testcontainers."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"integration testing bdd-style","name":"integration testing bdd-style","description":"introduction I\u0026amp;rsquo;ve written a few integration test frameworks where the tests were written as JUnit @Test methods and defined via a fluent API that hid the plumbing from the …","keywords":["testing","integration-testing","cucumber","testcontainers","bdd","kafka"],"articleBody":"introduction I’ve written a few integration test frameworks where the tests were written as JUnit @Test methods and defined via a fluent API that hid the plumbing from the test author. These were always executed against a mixture of locally installed \u0026 in-memory infrastructure.\nThis worked well-enough in small development teams where the developers wrote the tests but wasn’t so good when I considered it for a larger project with a bigger team. On this project:\n Less technical team-members needed to be able to write tests. The infrastructure was more complex \u0026 the team larger so there was a greater overhead of installing \u0026 maintaining the required software on each machine. The system-under-test included multiple applications rather than multiple components of a single larger application. These components might be using different versions of the same libraries so could not share a test-time classpath.  I found an alternative approach using Cucumber \u0026 TestContainers that addressed these challenges. This is not intended to be a comprehensive introduction to either Cucumber or Testcontainers - we’ll mostly be concerned with how to use these two tools together to write BDD-style integration tests.\ncucumber A BDD framework seemed a good fit for enabling non-developers to write tests and had the added advantage of replacing separate acceptance criteria in stories. I looked at JBehave \u0026 Cucumber \u0026 liked the look of the latter.\nCucumber tests are written as features using a business-readable language called Gherkin. It has just a handful of keywords used to define the preconditions, stimulus \u0026 expected outcome of a test in a Given-When-Then form. The implementation of these steps are then defined programmatically.\nFor example, given the following scenario defined using Gherkin…\nScenario:No coat required when it's warm Given The temperature is 20degrees. When I ask whether I need a coat Then I should be told \"No\" …the implementation of the first step would be defined in a method annotated like this.1\n@Given(\"The temperature is 20 degrees.\") public void temperatureIsTwentyDegrees() { // TODO interact with the system-under-test to set the temperature } testcontainers To address the other challenges, I decided to use Testcontainers - a rather amazing library for starting infrastructure like databases or messaging systems in Docker containers at test-time. You just need Docker installed to use it.\nFor example, starting a Maria DB instance in a JUnit test might look like this:\n@Container private MariaDBContainer database = new MariaDBContainer( DockerImageName.parse(\"mariadb\").withTag(\"10.5.9\") ); Every developer/build machine then gets exactly the same versions of infrastructure at test-time without any local installation (other than Docker itself). Upgrading that infrastructure simply involves changing the image used in the test.\nWhen used for databases, this approach also prevents contamination of the database between test runs.\nBy generating docker images from application builds too, I was also able to use Testcontainers to start the applications under test avoiding issues with conflicting library versions.2\nsystem under test (SUT) My real SUT involved multiple kafka-steams components and topics but here we’ll use a simplified example with a single kafka-stream sufficient to demonstrate the approach. The stream will receive details of placed orders from one topic, enrich them with details of the customer \u0026 product(s) from a database and provide a summary of the sale on another topic.\nAll messages will be in json.\nYou can see the source for the system under test here.\nIf this were a real application we might integrate the production of the docker image into the maven build but, for simplicity, here we’ll use an external Dockerfile. The image can be built by running the command docker build -t order-enrichment-stream . after running the maven build.\ntest framework To test this system we’ll start three containers - one each for Kafka, Maria DB \u0026 our Kafka Streams Application.\nWe’ll go over the layout of the project and then go into detail on each of the key components.\nproject set-up The project structure will look like this:\n. ├── pom.xml └── src/test ├── java │ └── dev.codecrumbs.sales.test │ │ ├──Pipeline.java │ │ ├──StepDefinitions.java │ │ ├──Topic.java │ │ └──Utils.java │ └── features.IntegrationTests.java └── resources ├── features │ └── sales-summarised.feature ├── test-data │ └── ... ├── cucumber.properties ├── junit-platform.properties └── schema.sql The key parts of this are:\nOur Feature - sales-summarised.feature (\u0026 the supporting json files under test-data) that defines the expected behaviour.\nThe Step Definitions - cucumber-annotated implementations of the test steps used in our feature.\nThe Pipeline class - an abstraction of our Kafka-pipeline that allows us to interact with the pipeline from our step definitions and controls start-up of the required containers.\nMaven \u0026 CLI Configuration - IntegrationTests.java, cucumber.properties \u0026 junit-platform.properties that allow the tests to be run from our IDE \u0026 Maven.\nour feature Our feature file will look like this. Note that we are using Cucumber’s support for parameterised test steps to allow us to run the same test multiple times with different inputs \u0026 expected outputs.\nFeature:Sales are ingested. Scenario:Details of a sale are ingested. Scenario Outline: Given An existing customer of \"\". And A product catalog of \"\". When Order \"\" is placed. Then The Sales Team are notified of Order \"\". Scenarios: | customer| product-catalog| order| summary||mary-jones|lemons-and-bananas|marys-order|marys-order-summary||john-smith|apples-and-pears|johns-order|johns-order-summary| To keep the feature file readable, the customer, product catalog, placed order \u0026 expected sale summary will be loaded from separate json files. The scenarios above give the names of these files (minus the .json extension). They’ll look like this for the first scenario:\nmary-jones.json - we want this customer to be present in the system at the start of the test.\n{ \"id\": 392, \"name\": \"Mary Jones\" } lemons-and-bananas.json - we want the following catalog of products to be present in the system at the start of the test.\n[ { \"id\": 812, \"item\": \"Lemons\", \"unitPrice\": 0.66 }, { \"id\": 944, \"item\": \"Bananas\", \"unitPrice\": 0.19 } ] marys-order.json - we want this order to be injected into the system as a placed order.\n{ \"customerId\": 392, \"items\": [ { \"productId\": 812, \"quantity\": 2 }, { \"productId\": 944, \"quantity\": 7 } ] } marys-order-summary.json - given the above preconditions \u0026 the injection of our order, we expect the system to produce the following sale summary.\n{ \"customerName\": \"Mary Jones\", \"itemsDescriptions\": [\"Lemons\",\"Bananas\"], \"value\": 2.65 } step definitions We’ll define the following step definitions to support our feature:\nWe need two @Given steps to set the system up for our test - one for adding customers \u0026 one for adding a catalog of the products sold. The actual loading to the database is done in our Pipeleine class which we’ll look at later.\n@Given(\"An existing customer of {string}.\") public void anExistingCustomer(String customer) throws SQLException { LOG.info(\"Loading existing customer {}\", customer); Pipeline.insertCustomer( Utils.loadJson(String.format(\"/test-data/customers/%s.json\", customer)) ); } @Given(\"A product catalog of {string}.\") public void aProductCatalogOf(String catalog) throws SQLException { LOG.info(\"Loading product catalog {}\", catalog); Pipeline.insertProducts( Utils.loadJson(String.format(\"/test-data/product-catalogs/%s.json\", catalog)) ); } Our @When step will load the order from file and send it to the orders topic. Again the actual work of sending the message is delegated to the Pipeline class.\n@When(\"Order {string} is placed.\") public void orderIsReceived(String order) { orderNumber = ThreadLocalRandom.current().nextInt(1000000); LOG.info(\"Injecting order {} with order number {}\", order, orderNumber); Pipeline.send( Topic.ORDERS, orderNumber, Utils.loadJson(String.format(\"/test-data/orders/%s.json\", order)) ); } Finally we need to define our @Then step to verify that the expected sale-summary is received on the sales topic. The retrieval of the messages from the Kafka topic is also delegated to the Pipeline class. We assert that the topic contains exactly one message with the expected key (the order number) \u0026 sale-summary.\n@Then(\"The Sales Team are notified of Order {string}.\") public void salesTeamAreNotifiedOfOrder(String orderSummary) { LOG.info(\"Verifying that order summary {} is received.\", orderSummary); Awaitility.await().atMost(Duration.ofSeconds(10)).untilAsserted( () - assertThat(Pipeline.messagesOn(Topic.SALES)) .hasSize(1) .containsOnlyKeys(orderNumber) .containsValue( Utils.loadJson( String.format(\"/test-data/sales-summaries/%s.json\", orderSummary) ) ) ); } the pipeline class The real work will be done in the Pipeline class. It will contain the logic for setting the system up with the required data for our test, injecting messages to a topic and retrieving messages for verification. It will also start our application \u0026 the infrastructure we need to test our pipeline.\nresponding to lifecycle events Before we dive into the code though, I need to explain something. Starting Docker containers takes a little time so we want to share the containers between our Cucumber scenarios. When writing tests with JUnit Jupiter this is easy using the annotations @Testcontainers and @Container. When the latter is applied to a static field, Testcontainers will start containers \u0026 share them amongst our @Test methods.\nWe need to achieve the same thing with Cucumber. It has its own @Before annotation triggered before each scenario but not yet a @BeforeAll which would be useful for starting containers exactly once.3\nI looked at a couple of options to overcome this but settled on a solution that used Cucumber’s Plugin mechanism. This allows us to listen to Cucumber lifecycle events and start our containers exactly once. Our Pipeline class is therefore implemented as a plugin - specifically it implements EventListener and registers handlers so that our pipeline is notified when a test-run start \u0026 stops \u0026 when a test-case starts.\npublic class Pipeline implements EventListener { ... @Override public void setEventPublisher(EventPublisher publisher) { publisher.registerHandlerFor(TestRunStarted.class, startUp); publisher.registerHandlerFor(TestCaseStarted.class, startTestCase); publisher.registerHandlerFor(TestRunFinished.class, shutDown); } ... } Before looking at the three handlers, let’s look at the definition of the containers we’ll use. There are a few things worth noting:\n We are attaching a log consumer to each container so that we can see the container’s logging in our main log. We are using a Testcontainers wait strategy to wait for a log statement that indicates that the containers are ready for use before the tests run. This is not necessary for our database container as it this is built into the JdbcDatabaseContainer base class. We specify an initialisation script for our database container that creates our customers \u0026 products schema.  private static final KafkaContainer KAFKA = new KafkaContainer(DockerImageName.parse(\"confluentinc/cp-kafka:6.0.1\")) .withLogConsumer(logConsumer(\"kafka-container\")) .waitingFor(Wait.forLogMessage(\".*KafkaServer.*started.*\", 1)); private static final MariaDBContainer DATABASE = new MariaDBContainer(DockerImageName.parse(\"mariadb:10.5.9\")) .withInitScript(\"schema.sql\") .withLogConsumer(logConsumer(\"maria-db\")); private static final GenericContainer APPLICATION = new GenericContainer(DockerImageName.parse(\"order-enrichment-stream\")) .withLogConsumer(logConsumer(\"order-enrichment-stream\")) .waitingFor(Wait.forLogMessage(\".*Started Application.*\", 1)); Next we’ll look at the three handlers in turn starting with the startUp handler.\nstart-up handler At the start of the test-run, we’ll create our three containers \u0026 place them on the same docker network, create the required Kafka topics \u0026 initialise our Kafka consumer for later message verification. Environment variables are used to configure our spring-boot application using Testcontainers' withEnv().\nprivate final EventHandlerTestRunStarted startUp = testRunStarted - { Network network = Network.newNetwork(); KAFKA.withNetwork(network).start(); DATABASE.withNetwork(network).start(); APPLICATION.withNetwork(network) .withEnv(applicationEnvironment()) .start(); Utils.createTopics(KAFKA); kafkaConsumer = Utils.consumerFor(Topic.SALES, KAFKA); }; The environment variables we’ll pass to the application container are shown below and include the kafka \u0026 database urls. Note that the host part of the url is obtained by getting the network alias of the corresponding container.\nprivate MapString, String applicationEnvironment() { return Map.of( \"spring.kafka.bootstrapServers\", KAFKA.getNetworkAliases().get(0) + \":9092\", \"spring.cloud.stream.kafka.binder.brokers\", KAFKA.getNetworkAliases().get(0) + \":9092\", \"spring.cloud.stream.bindings.enrichOrder-in-0.destination\", Topic.ORDERS.value(), \"spring.cloud.stream.bindings.enrichOrder-out-0.destination\", Topic.SALES.value(), \"spring.datasource.url\", \"jdbc:mariadb://\" + DATABASE.getNetworkAliases().get(0) + \":3306/\" + DATABASE.getDatabaseName(), \"spring.datasource.username\", DATABASE.getUsername(), \"spring.datasource.password\", DATABASE.getPassword() ); } start-test-case handler The startTestCase handler will run before each scenario and will delete the customers \u0026 products from our test database so that it is ready for the next scenario.\nprivate final EventHandlerTestCaseStarted startTestCase = testCaseStarted - { Utils.jdbcTemplateFor(DATABASE).update(\"delete from customers\"); Utils.jdbcTemplateFor(DATABASE).update(\"delete from products\"); }; shut-down handler Finally, the shutDown handler will stop our containers.\nprivate final EventHandlerTestRunFinished shutDown = testRunFinished - { KAFKA.stop(); DATABASE.stop(); APPLICATION.stop(); }; creating database records Our steps require that we are able to add customers \u0026 a product catalog to our database before we test a scenario. This will be supported by the following methods.\npublic static void insertCustomer(JsonNode customer) throws SQLException { Utils.jdbcTemplateFor(DATABASE).update( \"insert into customers (id, name) values (?, ?)\", customer.get(\"id\").intValue(), customer.get(\"name\").textValue() ); } public static void insertProducts(JsonNode productCatalog) throws SQLException { JdbcTemplate jdbcTemplate = Utils.jdbcTemplateFor(DATABASE); for (JsonNode eachProduct : productCatalog) { jdbcTemplate.update( \"insert into products (id, description, unit_price) values (?, ?, ?)\", eachProduct.get(\"id\").intValue(), eachProduct.get(\"item\").textValue(), eachProduct.get(\"unitPrice\").decimalValue() ); } } sending and receiving messages The final part of our Pipeline class will be supporting the step definitions that involve sending an order message to a kafka topic and checking the sale-summary message on another topic. They are supported by the following methods.\npublic static void send(Topic topic, int orderNumber, JsonNode document) { Utils.send( KAFKA, new ProducerRecord( topic.value(), orderNumber, document.toString() ) ); } public static MapInteger, JsonNode messagesOn(Topic topic) { return StreamSupport.stream( KafkaTestUtils.getRecords(kafkaConsumer) .records(topic.value()).spliterator(), false ).collect(Collectors.toMap(ConsumerRecord::key, r - Utils.toJson(r.value()))); } maven \u0026 cli configuration  To wrap-up we’ll look at what is involved in getting the tests to run from an IDE and maven.\nRunning tests from IntelliJ or Eclipse involves using Cucumber’s CLI. This is configured using the cucumber.properties file. We’ll use Surefire to run the tests from our Maven build which is instead configured with junit-platform.properties.4 These two files are therefore identical \u0026 contain a single property , cucumber.plugin=dev.codecrumbs.sales.test.Pipeline which will ensure Cucumber uses our Pipeline plugin class.\nFor feature files to be found by the maven surefire plugin we also need a class annotated with @Cucumber in the same package as the features. In our case this will be named IntegrationTests.\nThat’s it! The tests will now run as part of the maven build or from an IDE. They look like this in IntelliJ:\n source.\nsystem under test.\ncucumber.\ncucumber-jvm.\ntestcontainers.\n  I am showing annotation-based step definitions here as I personally find them more readable than the lambda alternatives available as part of cucumber-java8. ↩︎\n I initially tried to start the applications under test in the same JVM as the tests \u0026 imported the applications via maven dependencies but I had to abandon this approach as I did not want to restrict the applications to having the same versions of common libraries. ↩︎\n A @BeforeAll annotation will be added in cucumber-jvm v7 - see this issue. ↩︎\n There may be other approaches that would use the CLI \u0026, therefore, the same configuration file. ↩︎\n   ","wordCount":"2302","inLanguage":"en","datePublished":"2021-05-08T17:22:00Z","dateModified":"2021-05-08T17:22:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.codecrumbs.dev/posts/cucumber-integration-tests/"},"publisher":{"@type":"Organization","name":"codecrumbs","logo":{"@type":"ImageObject","url":"https://www.codecrumbs.dev/images/favicon.ico"}}}</script></head><body class=dark id=top><script>if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}</script><noscript><style type=text/css>.theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://www.codecrumbs.dev accesskey=h title="codecrumbs (Alt + H)"><img src=/images/profile.png alt=logo aria-label=logo height=50px>codecrumbs</a>
<span class=logo-switches><span class=theme-toggle title="(Alt + T)"><a id=theme-toggle accesskey=t><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></a></span></span></div><ul class=menu id=menu onscroll=menu_on_scroll()><li><a href=https://www.codecrumbs.dev/tags/ title=tags><span>tags</span></a></li><li><a href=https://www.codecrumbs.dev/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.codecrumbs.dev/about title=about><span>about</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>integration testing bdd-style</h1><div class=post-description>Testing a Kafka Pipeline with Cucumber & Testcontainers.</div><div class=post-meta>May 8, 2021&nbsp;·&nbsp;11 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><blockquote><ul><li><a href=#introduction aria-label=introduction>introduction</a><ul><li><a href=#cucumber aria-label=cucumber>cucumber</a></li><li><a href=#testcontainers aria-label=testcontainers>testcontainers</a></li></ul></li><li><a href=#system-under-test-sut aria-label="system under test (SUT)">system under test (SUT)</a></li><li><a href=#test-framework aria-label="test framework">test framework</a><ul><li><a href=#project-set-up aria-label="project set-up">project set-up</a></li><li><a href=#feature aria-label="our feature">our feature</a></li><li><a href=#step-definitions aria-label="step definitions">step definitions</a></li><li><a href=#pipeline aria-label="the pipeline class">the pipeline class</a><ul><li><a href=#responding-to-lifecycle-events aria-label="responding to lifecycle events">responding to lifecycle events</a></li><li><a href=#start-up-handler aria-label="start-up handler">start-up handler</a></li><li><a href=#start-test-case-handler aria-label="start-test-case handler">start-test-case handler</a></li><li><a href=#shut-down-handler aria-label="shut-down handler">shut-down handler</a></li><li><a href=#creating-database-records aria-label="creating database records">creating database records</a></li><li><a href=#sending-and-receiving-messages aria-label="sending and receiving messages">sending and receiving messages</a></li></ul></li><li><a href=#maven-cli aria-label="maven &amp;amp; cli configuration">maven & cli configuration</a></li></ul></li></ul></blockquote></details></div><div class=post-content><h2 id=introduction>introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>I&rsquo;ve written a few integration test frameworks where the tests were written as JUnit <code>@Test</code> methods and
defined via a fluent API that hid the plumbing from the test author. These were always executed against a
mixture of locally installed & in-memory infrastructure.</p><p>This worked well-enough in small development teams where the developers wrote the tests but wasn&rsquo;t so good when I considered
it for a larger project with a bigger team. On this project:</p><ul><li>Less technical team-members needed to be able to write tests.</li><li>The infrastructure was more complex & the team larger so there was a greater overhead of installing & maintaining the required software
on each machine.</li><li>The system-under-test included multiple applications rather than multiple components of a single larger application. These
components might be using different versions of the same libraries so could not share a test-time classpath.</li></ul><p>I found an alternative approach using Cucumber & TestContainers that addressed these challenges.
This is not intended to be a comprehensive introduction to either Cucumber or Testcontainers - we&rsquo;ll mostly be concerned
with how to use these two tools together to write BDD-style integration tests.</p><h3 id=cucumber>cucumber<a hidden class=anchor aria-hidden=true href=#cucumber>#</a></h3><p>A BDD framework seemed a good fit for enabling non-developers to write tests and had the added advantage of replacing separate
acceptance criteria in stories. I looked at JBehave & Cucumber & liked the look of the latter.</p><p>Cucumber tests are written as features using a business-readable language called Gherkin. It has just a handful of keywords
used to define the preconditions, stimulus & expected outcome of a test in a Given-When-Then form. The implementation of
these steps are then defined programmatically.</p><p>For example, given the following scenario defined using Gherkin&mldr;</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gherkin data-lang=gherkin><span style=color:#66d9ef>Scenario:</span><span style=color:#a6e22e> No coat required when it&#39;s warm
</span><span style=color:#a6e22e></span><span style=color:#66d9ef>  Given </span><span style=color:#a6e22e>The temperature is </span><span style=color:#e6db74>20</span><span style=color:#a6e22e> degrees.
</span><span style=color:#a6e22e>  </span><span style=color:#66d9ef>When </span><span style=color:#a6e22e>I ask whether I need a coat
</span><span style=color:#a6e22e>  </span><span style=color:#66d9ef>Then </span><span style=color:#a6e22e>I should be told &#34;</span><span style=color:#e6db74>No</span><span style=color:#a6e22e>&#34;
</span></code></pre></div><p>&mldr;the implementation of the first step would be defined in a method annotated like this.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Given</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The temperature is 20 degrees.&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>temperatureIsTwentyDegrees</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    <span style=color:#75715e>// TODO interact with the system-under-test to set the temperature
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</code></pre></div><h3 id=testcontainers>testcontainers<a hidden class=anchor aria-hidden=true href=#testcontainers>#</a></h3><p>To address the other challenges, I decided to use Testcontainers - a rather amazing library for starting infrastructure like
databases or messaging systems in Docker containers at test-time. You just need Docker installed to use it.</p><p>For example, starting a Maria DB instance in a JUnit test might look like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Container</span>
<span style=color:#66d9ef>private</span> MariaDBContainer database <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MariaDBContainer<span style=color:#f92672>(</span>
        DockerImageName<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mariadb&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>withTag</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;10.5.9&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#f92672>);</span>
</code></pre></div><p>Every developer/build machine then gets exactly the same versions of infrastructure at test-time without any local
installation (other than Docker itself). Upgrading that infrastructure simply involves changing the image used in the test.<br>When used for databases, this approach also prevents contamination of the database between test runs.</p><p>By generating docker images from application builds too, I was also able to use Testcontainers to start the applications
under test avoiding issues with conflicting library versions.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><h2 id=system-under-test-sut>system under test (SUT)<a hidden class=anchor aria-hidden=true href=#system-under-test-sut>#</a></h2><p>My real SUT involved multiple kafka-steams components and topics but here we&rsquo;ll use a simplified example with a single
kafka-stream sufficient to demonstrate the approach. The stream will receive details of placed orders from one topic, enrich them
with details of the customer & product(s) from a database and provide a summary of the sale on another topic.<br>All messages will be in json.</p><p>You can see the source for the system under test <a href=https://github.com/codecrumbs-dev/order-enrichment-stream>here</a>.</p><p>If this were a real application we might integrate the production of the docker image into the maven build but, for
simplicity, here we&rsquo;ll use an external Dockerfile. The image can be built by running the command <code>docker build -t order-enrichment-stream .</code> after running the maven build.</p><h2 id=test-framework>test framework<a hidden class=anchor aria-hidden=true href=#test-framework>#</a></h2><p>To test this system we&rsquo;ll start three containers - one each for Kafka, Maria DB & our Kafka Streams Application.</p><p>We&rsquo;ll go over the layout of the project and then go into detail on each of the key components.</p><p><img src=/post-images/order-enrichment.svg alt=test-setup></p><h3 id=project-set-up>project set-up<a hidden class=anchor aria-hidden=true href=#project-set-up>#</a></h3><p>The project structure will look like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>.
├── pom.xml
└── src/test
    ├── java
    │   └── dev.codecrumbs.sales.test
    │   │   ├──Pipeline.java
    │   │   ├──StepDefinitions.java
    │   │   ├──Topic.java
    │   │   └──Utils.java  
    │   └── features.IntegrationTests.java                
    └── resources
        ├── features
        │   └── sales-summarised.feature 
        ├── test-data
        │   └── ...  
        ├── cucumber.properties
        ├── junit-platform.properties
        └── schema.sql        
</code></pre></div><p>The key parts of this are:</p><p><a href=#feature title=Feature>Our Feature</a> - <code>sales-summarised.feature</code> (& the supporting json files under <code>test-data</code>) that defines the expected behaviour.</p><p><a href=#step-definitions title="Step Definitions">The Step Definitions</a> - cucumber-annotated implementations of the test steps used in our feature.</p><p><a href=#pipeline title="Pipeline Class">The Pipeline class</a> - an abstraction of our Kafka-pipeline that allows us to interact with the pipeline from our step definitions
and controls start-up of the required containers.</p><p><a href=#maven-cli title="Running Tests">Maven & CLI Configuration</a> - <code>IntegrationTests.java</code>, <code>cucumber.properties</code> & <code>junit-platform.properties</code> that allow the tests to be run from our IDE & Maven.</p><h3 id=feature>our feature<a hidden class=anchor aria-hidden=true href=#feature>#</a></h3><p>Our feature file will look like this. Note that we are using Cucumber&rsquo;s support for parameterised test steps to
allow us to run the same test multiple times with different inputs & expected outputs.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gherkin data-lang=gherkin><span style=color:#66d9ef>Feature:</span><span style=color:#a6e22e> Sales are ingested.
</span><span style=color:#a6e22e>  </span><span style=color:#66d9ef>Scenario:</span><span style=color:#a6e22e> Details of a sale are ingested.
</span><span style=color:#a6e22e>
</span><span style=color:#a6e22e>  Scenario Outline:
</span><span style=color:#a6e22e></span><span style=color:#66d9ef>    Given </span><span style=color:#a6e22e>An existing customer of &#34;</span>&lt;customer&gt;<span style=color:#a6e22e>&#34;.
</span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>And </span><span style=color:#a6e22e>A product catalog of &#34;</span>&lt;product-catalog&gt;<span style=color:#a6e22e>&#34;.
</span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>When </span><span style=color:#a6e22e>Order &#34;</span>&lt;order&gt;<span style=color:#a6e22e>&#34; is placed.
</span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>Then </span><span style=color:#a6e22e>The Sales Team are notified of Order &#34;</span>&lt;summary&gt;<span style=color:#a6e22e>&#34;.
</span><span style=color:#a6e22e>    </span><span style=color:#66d9ef>Scenarios:
</span><span style=color:#66d9ef>      |</span> customer<span style=color:#66d9ef>   |</span> product-catalog<span style=color:#66d9ef>    |</span> order<span style=color:#66d9ef>       |</span> summary<span style=color:#66d9ef>             |</span><span style=color:#a6e22e>
</span><span style=color:#a6e22e></span><span style=color:#66d9ef>      |</span><span style=color:#e6db74> mary-jones</span><span style=color:#66d9ef> |</span><span style=color:#e6db74> lemons-and-bananas</span><span style=color:#66d9ef> |</span><span style=color:#e6db74> marys-order</span><span style=color:#66d9ef> |</span><span style=color:#e6db74> marys-order-summary</span><span style=color:#66d9ef> |</span><span style=color:#a6e22e>
</span><span style=color:#a6e22e></span><span style=color:#66d9ef>      |</span><span style=color:#e6db74> john-smith</span><span style=color:#66d9ef> |</span><span style=color:#e6db74> apples-and-pears</span><span style=color:#66d9ef>   |</span><span style=color:#e6db74> johns-order</span><span style=color:#66d9ef> |</span><span style=color:#e6db74> johns-order-summary</span><span style=color:#66d9ef> |
</span></code></pre></div><p>To keep the feature file readable, the customer, product catalog, placed order & expected sale summary will be
loaded from separate json files. The scenarios above give the names of these files (minus the <code>.json</code> extension).
They&rsquo;ll look like this for the first scenario:</p><p><code>mary-jones.json</code> - we want this customer to be present in the system at the start of the test.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>392</span>,
  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Mary Jones&#34;</span>
}
</code></pre></div><p><code>lemons-and-bananas.json</code> - we want the following catalog of products to be present in the system at the start of the test.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
  {
    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>812</span>,
    <span style=color:#f92672>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;Lemons&#34;</span>,
    <span style=color:#f92672>&#34;unitPrice&#34;</span>: <span style=color:#ae81ff>0.66</span>
  },
  {
    <span style=color:#f92672>&#34;id&#34;</span>: <span style=color:#ae81ff>944</span>,
    <span style=color:#f92672>&#34;item&#34;</span>: <span style=color:#e6db74>&#34;Bananas&#34;</span>,
    <span style=color:#f92672>&#34;unitPrice&#34;</span>: <span style=color:#ae81ff>0.19</span>
  }

]
</code></pre></div><p><code>marys-order.json</code> - we want this order to be injected into the system as a placed order.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;customerId&#34;</span>: <span style=color:#ae81ff>392</span>,
  <span style=color:#f92672>&#34;items&#34;</span>: [
    {
      <span style=color:#f92672>&#34;productId&#34;</span>: <span style=color:#ae81ff>812</span>,
      <span style=color:#f92672>&#34;quantity&#34;</span>: <span style=color:#ae81ff>2</span>
    },
    {
      <span style=color:#f92672>&#34;productId&#34;</span>: <span style=color:#ae81ff>944</span>,
      <span style=color:#f92672>&#34;quantity&#34;</span>: <span style=color:#ae81ff>7</span>
    }
  ]
}
</code></pre></div><p><code>marys-order-summary.json</code> - given the above preconditions & the injection of our order, we expect the system to produce the following sale summary.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;customerName&#34;</span>: <span style=color:#e6db74>&#34;Mary Jones&#34;</span>,
  <span style=color:#f92672>&#34;itemsDescriptions&#34;</span>: [<span style=color:#e6db74>&#34;Lemons&#34;</span>,<span style=color:#e6db74>&#34;Bananas&#34;</span>],
  <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#ae81ff>2.65</span>
}
</code></pre></div><h3 id=step-definitions>step definitions<a hidden class=anchor aria-hidden=true href=#step-definitions>#</a></h3><p>We&rsquo;ll define the following step definitions to support our feature:</p><p>We need two <code>@Given</code> steps to set the system up for our test - one for adding customers & one for adding a catalog
of the products sold. The actual loading to the database is done in our <code>Pipeleine</code> class which we&rsquo;ll look at later.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Given</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;An existing customer of {string}.&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>anExistingCustomer</span><span style=color:#f92672>(</span>String customer<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
  LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Loading existing customer {}&#34;</span><span style=color:#f92672>,</span> customer<span style=color:#f92672>);</span>
  Pipeline<span style=color:#f92672>.</span><span style=color:#a6e22e>insertCustomer</span><span style=color:#f92672>(</span>
    Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>loadJson</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/test-data/customers/%s.json&#34;</span><span style=color:#f92672>,</span> customer<span style=color:#f92672>))</span>
  <span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>

<span style=color:#a6e22e>@Given</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;A product catalog of {string}.&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>aProductCatalogOf</span><span style=color:#f92672>(</span>String catalog<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
  LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Loading product catalog {}&#34;</span><span style=color:#f92672>,</span> catalog<span style=color:#f92672>);</span>
  Pipeline<span style=color:#f92672>.</span><span style=color:#a6e22e>insertProducts</span><span style=color:#f92672>(</span>
    Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>loadJson</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/test-data/product-catalogs/%s.json&#34;</span><span style=color:#f92672>,</span> catalog<span style=color:#f92672>))</span>
  <span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Our <code>@When</code> step will load the order from file and send it to the <code>orders</code> topic. Again the actual work of sending the
message is delegated to the Pipeline class.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@When</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Order {string} is placed.&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>orderIsReceived</span><span style=color:#f92672>(</span>String order<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
  orderNumber <span style=color:#f92672>=</span> ThreadLocalRandom<span style=color:#f92672>.</span><span style=color:#a6e22e>current</span><span style=color:#f92672>().</span><span style=color:#a6e22e>nextInt</span><span style=color:#f92672>(</span>1000000<span style=color:#f92672>);</span>
  LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Injecting order {} with order number {}&#34;</span><span style=color:#f92672>,</span> order<span style=color:#f92672>,</span> orderNumber<span style=color:#f92672>);</span>
  Pipeline<span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>
          Topic<span style=color:#f92672>.</span><span style=color:#a6e22e>ORDERS</span><span style=color:#f92672>,</span>
          orderNumber<span style=color:#f92672>,</span>
          Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>loadJson</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/test-data/orders/%s.json&#34;</span><span style=color:#f92672>,</span> order<span style=color:#f92672>))</span>
  <span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Finally we need to define our <code>@Then</code> step to verify that the expected sale-summary is received on the <code>sales</code> topic.
The retrieval of the messages from the Kafka topic is also delegated to the Pipeline class. We assert that the
topic contains exactly one message with the expected key (the order number) & sale-summary.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Then</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The Sales Team are notified of Order {string}.&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>salesTeamAreNotifiedOfOrder</span><span style=color:#f92672>(</span>String orderSummary<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
  LOG<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Verifying that order summary {} is received.&#34;</span><span style=color:#f92672>,</span> orderSummary<span style=color:#f92672>);</span>
  Awaitility<span style=color:#f92672>.</span><span style=color:#a6e22e>await</span><span style=color:#f92672>().</span><span style=color:#a6e22e>atMost</span><span style=color:#f92672>(</span>Duration<span style=color:#f92672>.</span><span style=color:#a6e22e>ofSeconds</span><span style=color:#f92672>(</span>10<span style=color:#f92672>)).</span><span style=color:#a6e22e>untilAsserted</span><span style=color:#f92672>(</span>
    <span style=color:#f92672>()</span> <span style=color:#f92672>-&gt;</span> assertThat<span style=color:#f92672>(</span>Pipeline<span style=color:#f92672>.</span><span style=color:#a6e22e>messagesOn</span><span style=color:#f92672>(</span>Topic<span style=color:#f92672>.</span><span style=color:#a6e22e>SALES</span><span style=color:#f92672>))</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>hasSize</span><span style=color:#f92672>(</span>1<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>containsOnlyKeys</span><span style=color:#f92672>(</span>orderNumber<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>containsValue</span><span style=color:#f92672>(</span>
              Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>loadJson</span><span style=color:#f92672>(</span>
                String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;/test-data/sales-summaries/%s.json&#34;</span><span style=color:#f92672>,</span> orderSummary<span style=color:#f92672>)</span>
              <span style=color:#f92672>)</span>
            <span style=color:#f92672>)</span>
  <span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=pipeline>the pipeline class<a hidden class=anchor aria-hidden=true href=#pipeline>#</a></h3><p>The real work will be done in the <code>Pipeline</code> class. It will contain the logic for setting the system up with the required data for
our test, injecting messages to a topic and retrieving messages for verification. It will also start our application & the
infrastructure we need to test our pipeline.</p><h4 id=responding-to-lifecycle-events>responding to lifecycle events<a hidden class=anchor aria-hidden=true href=#responding-to-lifecycle-events>#</a></h4><p>Before we dive into the code though, I need to explain something. Starting Docker containers takes a little time so we want to share the containers
between our Cucumber scenarios. When writing tests with JUnit Jupiter this is easy using the annotations <code>@Testcontainers</code> and <code>@Container</code>. When
the latter is applied to a static field, Testcontainers will start containers & share them amongst our <code>@Test</code> methods.</p><p>We need to achieve the same thing with Cucumber. It has its own <code>@Before</code> annotation triggered before each scenario but
not yet a <code>@BeforeAll</code> which would be useful for starting containers exactly once.<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><p>I looked at a couple of options to overcome this but settled on a solution
that used Cucumber&rsquo;s Plugin mechanism. This allows us to listen to Cucumber lifecycle events and start our containers exactly once. Our
<code>Pipeline</code> class is therefore implemented as a plugin - specifically it implements <code>EventListener</code> and registers handlers so that our
pipeline is notified when a test-run start & stops & when a test-case starts.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Pipeline</span> <span style=color:#66d9ef>implements</span> EventListener <span style=color:#f92672>{</span>
    <span style=color:#f92672>...</span>
    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setEventPublisher</span><span style=color:#f92672>(</span>EventPublisher publisher<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        publisher<span style=color:#f92672>.</span><span style=color:#a6e22e>registerHandlerFor</span><span style=color:#f92672>(</span>TestRunStarted<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> startUp<span style=color:#f92672>);</span>
        publisher<span style=color:#f92672>.</span><span style=color:#a6e22e>registerHandlerFor</span><span style=color:#f92672>(</span>TestCaseStarted<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> startTestCase<span style=color:#f92672>);</span>
        publisher<span style=color:#f92672>.</span><span style=color:#a6e22e>registerHandlerFor</span><span style=color:#f92672>(</span>TestRunFinished<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>,</span> shutDown<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
    <span style=color:#f92672>...</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Before looking at the three handlers, let&rsquo;s look at the definition of the containers we&rsquo;ll use.
There are a few things worth noting:</p><ul><li>We are attaching a log consumer to each container so that we can see the container&rsquo;s logging in
our main log.</li><li>We are using a Testcontainers wait strategy to wait for a log statement that indicates that the
containers are ready for use before the tests run. This is not necessary for our database container
as it this is built into the <code>JdbcDatabaseContainer</code> base class.</li><li>We specify an initialisation script for our database container that creates our customers & products
schema.</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> KafkaContainer KAFKA <span style=color:#f92672>=</span>
        <span style=color:#66d9ef>new</span> KafkaContainer<span style=color:#f92672>(</span>DockerImageName<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;confluentinc/cp-kafka:6.0.1&#34;</span><span style=color:#f92672>))</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>withLogConsumer</span><span style=color:#f92672>(</span>logConsumer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;kafka-container&#34;</span><span style=color:#f92672>))</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>waitingFor</span><span style=color:#f92672>(</span>Wait<span style=color:#f92672>.</span><span style=color:#a6e22e>forLogMessage</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.*KafkaServer.*started.*&#34;</span><span style=color:#f92672>,</span> 1<span style=color:#f92672>));</span>

<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> MariaDBContainer<span style=color:#f92672>&lt;?&gt;</span> DATABASE <span style=color:#f92672>=</span>
        <span style=color:#66d9ef>new</span> MariaDBContainer<span style=color:#f92672>&lt;&gt;(</span>DockerImageName<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mariadb:10.5.9&#34;</span><span style=color:#f92672>))</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>withInitScript</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;schema.sql&#34;</span><span style=color:#f92672>)</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>withLogConsumer</span><span style=color:#f92672>(</span>logConsumer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;maria-db&#34;</span><span style=color:#f92672>));</span>

<span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> GenericContainer<span style=color:#f92672>&lt;?&gt;</span> APPLICATION <span style=color:#f92672>=</span>
        <span style=color:#66d9ef>new</span> GenericContainer<span style=color:#f92672>&lt;&gt;(</span>DockerImageName<span style=color:#f92672>.</span><span style=color:#a6e22e>parse</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;order-enrichment-stream&#34;</span><span style=color:#f92672>))</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>withLogConsumer</span><span style=color:#f92672>(</span>logConsumer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;order-enrichment-stream&#34;</span><span style=color:#f92672>))</span>
        <span style=color:#f92672>.</span><span style=color:#a6e22e>waitingFor</span><span style=color:#f92672>(</span>Wait<span style=color:#f92672>.</span><span style=color:#a6e22e>forLogMessage</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;.*Started Application.*&#34;</span><span style=color:#f92672>,</span> 1<span style=color:#f92672>));</span>
</code></pre></div><p>Next we&rsquo;ll look at the three handlers in turn starting with the <code>startUp</code> handler.</p><h4 id=start-up-handler>start-up handler<a hidden class=anchor aria-hidden=true href=#start-up-handler>#</a></h4><p>At the start of the test-run, we&rsquo;ll
create our three containers & place them on the same docker network, create the required Kafka topics & initialise our
Kafka consumer for later message verification. Environment variables are used to configure our spring-boot application
using Testcontainers' <code>withEnv()</code>.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EventHandler<span style=color:#f92672>&lt;</span>TestRunStarted<span style=color:#f92672>&gt;</span> startUp <span style=color:#f92672>=</span> testRunStarted <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
        Network network <span style=color:#f92672>=</span> Network<span style=color:#f92672>.</span><span style=color:#a6e22e>newNetwork</span><span style=color:#f92672>();</span>
        KAFKA<span style=color:#f92672>.</span><span style=color:#a6e22e>withNetwork</span><span style=color:#f92672>(</span>network<span style=color:#f92672>).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        DATABASE<span style=color:#f92672>.</span><span style=color:#a6e22e>withNetwork</span><span style=color:#f92672>(</span>network<span style=color:#f92672>).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        APPLICATION<span style=color:#f92672>.</span><span style=color:#a6e22e>withNetwork</span><span style=color:#f92672>(</span>network<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>withEnv</span><span style=color:#f92672>(</span>applicationEnvironment<span style=color:#f92672>())</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
        Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>createTopics</span><span style=color:#f92672>(</span>KAFKA<span style=color:#f92672>);</span>
        kafkaConsumer <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>consumerFor</span><span style=color:#f92672>(</span>Topic<span style=color:#f92672>.</span><span style=color:#a6e22e>SALES</span><span style=color:#f92672>,</span> KAFKA<span style=color:#f92672>);</span>
    <span style=color:#f92672>};</span>
</code></pre></div><p>The environment variables we&rsquo;ll pass to the application container are shown below and include the kafka & database urls. Note
that the host part of the url is obtained by getting the network alias of the corresponding container.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>private</span> Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>applicationEnvironment</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> Map<span style=color:#f92672>.</span><span style=color:#a6e22e>of</span><span style=color:#f92672>(</span>
            <span style=color:#e6db74>&#34;spring.kafka.bootstrapServers&#34;</span><span style=color:#f92672>,</span> 
            KAFKA<span style=color:#f92672>.</span><span style=color:#a6e22e>getNetworkAliases</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:9092&#34;</span><span style=color:#f92672>,</span>
            <span style=color:#e6db74>&#34;spring.cloud.stream.kafka.binder.brokers&#34;</span><span style=color:#f92672>,</span> 
            KAFKA<span style=color:#f92672>.</span><span style=color:#a6e22e>getNetworkAliases</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:9092&#34;</span><span style=color:#f92672>,</span>
            <span style=color:#e6db74>&#34;spring.cloud.stream.bindings.enrichOrder-in-0.destination&#34;</span><span style=color:#f92672>,</span> 
            Topic<span style=color:#f92672>.</span><span style=color:#a6e22e>ORDERS</span><span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span>
            <span style=color:#e6db74>&#34;spring.cloud.stream.bindings.enrichOrder-out-0.destination&#34;</span><span style=color:#f92672>,</span> 
            Topic<span style=color:#f92672>.</span><span style=color:#a6e22e>SALES</span><span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span>
            <span style=color:#e6db74>&#34;spring.datasource.url&#34;</span><span style=color:#f92672>,</span> 
            <span style=color:#e6db74>&#34;jdbc:mariadb://&#34;</span> <span style=color:#f92672>+</span> DATABASE<span style=color:#f92672>.</span><span style=color:#a6e22e>getNetworkAliases</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>0<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> 
                <span style=color:#e6db74>&#34;:3306/&#34;</span> <span style=color:#f92672>+</span> DATABASE<span style=color:#f92672>.</span><span style=color:#a6e22e>getDatabaseName</span><span style=color:#f92672>(),</span>
            <span style=color:#e6db74>&#34;spring.datasource.username&#34;</span><span style=color:#f92672>,</span> 
            DATABASE<span style=color:#f92672>.</span><span style=color:#a6e22e>getUsername</span><span style=color:#f92672>(),</span>
            <span style=color:#e6db74>&#34;spring.datasource.password&#34;</span><span style=color:#f92672>,</span> 
            DATABASE<span style=color:#f92672>.</span><span style=color:#a6e22e>getPassword</span><span style=color:#f92672>()</span>
    <span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=start-test-case-handler>start-test-case handler<a hidden class=anchor aria-hidden=true href=#start-test-case-handler>#</a></h4><p>The <code>startTestCase</code> handler will run before each scenario and will delete the customers & products from our test
database so that it is ready for the next scenario.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EventHandler<span style=color:#f92672>&lt;</span>TestCaseStarted<span style=color:#f92672>&gt;</span> startTestCase <span style=color:#f92672>=</span> testCaseStarted <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
        Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>jdbcTemplateFor</span><span style=color:#f92672>(</span>DATABASE<span style=color:#f92672>).</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;delete from customers&#34;</span><span style=color:#f92672>);</span>
        Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>jdbcTemplateFor</span><span style=color:#f92672>(</span>DATABASE<span style=color:#f92672>).</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;delete from products&#34;</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>};</span>
</code></pre></div><h4 id=shut-down-handler>shut-down handler<a hidden class=anchor aria-hidden=true href=#shut-down-handler>#</a></h4><p>Finally, the <code>shutDown</code> handler will stop our containers.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> EventHandler<span style=color:#f92672>&lt;</span>TestRunFinished<span style=color:#f92672>&gt;</span> shutDown <span style=color:#f92672>=</span> testRunFinished <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
        KAFKA<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
        DATABASE<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
        APPLICATION<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
    <span style=color:#f92672>};</span>
</code></pre></div><h4 id=creating-database-records>creating database records<a hidden class=anchor aria-hidden=true href=#creating-database-records>#</a></h4><p>Our steps require that we are able to add customers & a product catalog to our database before we test a scenario.
This will be supported by the following methods.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insertCustomer</span><span style=color:#f92672>(</span>JsonNode customer<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
    Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>jdbcTemplateFor</span><span style=color:#f92672>(</span>DATABASE<span style=color:#f92672>).</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>
        <span style=color:#e6db74>&#34;insert into customers (id, name) values (?, ?)&#34;</span><span style=color:#f92672>,</span>
        customer<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>intValue</span><span style=color:#f92672>(),</span>
        customer<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;name&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>textValue</span><span style=color:#f92672>()</span>
    <span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>insertProducts</span><span style=color:#f92672>(</span>JsonNode productCatalog<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> SQLException <span style=color:#f92672>{</span>
    JdbcTemplate jdbcTemplate <span style=color:#f92672>=</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>jdbcTemplateFor</span><span style=color:#f92672>(</span>DATABASE<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>JsonNode eachProduct <span style=color:#f92672>:</span> productCatalog<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        jdbcTemplate<span style=color:#f92672>.</span><span style=color:#a6e22e>update</span><span style=color:#f92672>(</span>
            <span style=color:#e6db74>&#34;insert into products (id, description, unit_price) values (?, ?, ?)&#34;</span><span style=color:#f92672>,</span>
            eachProduct<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;id&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>intValue</span><span style=color:#f92672>(),</span>
            eachProduct<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;item&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>textValue</span><span style=color:#f92672>(),</span>
            eachProduct<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;unitPrice&#34;</span><span style=color:#f92672>).</span><span style=color:#a6e22e>decimalValue</span><span style=color:#f92672>()</span>
        <span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h4 id=sending-and-receiving-messages>sending and receiving messages<a hidden class=anchor aria-hidden=true href=#sending-and-receiving-messages>#</a></h4><p>The final part of our <code>Pipeline</code> class will be supporting the step definitions that involve sending an order
message to a kafka topic and checking the sale-summary message on another topic. They are supported by the following
methods.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>Topic topic<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> orderNumber<span style=color:#f92672>,</span> JsonNode document<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>
        KAFKA<span style=color:#f92672>,</span>
        <span style=color:#66d9ef>new</span> ProducerRecord<span style=color:#f92672>&lt;&gt;(</span>
            topic<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>(),</span>
            orderNumber<span style=color:#f92672>,</span>
            document<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span>
        <span style=color:#f92672>)</span>
    <span style=color:#f92672>);</span>
<span style=color:#f92672>}</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>Integer<span style=color:#f92672>,</span> JsonNode<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>messagesOn</span><span style=color:#f92672>(</span>Topic topic<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>return</span> StreamSupport<span style=color:#f92672>.</span><span style=color:#a6e22e>stream</span><span style=color:#f92672>(</span>
        KafkaTestUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>getRecords</span><span style=color:#f92672>(</span>kafkaConsumer<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>records</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>()).</span><span style=color:#a6e22e>spliterator</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>false</span>
    <span style=color:#f92672>).</span><span style=color:#a6e22e>collect</span><span style=color:#f92672>(</span>Collectors<span style=color:#f92672>.</span><span style=color:#a6e22e>toMap</span><span style=color:#f92672>(</span>ConsumerRecord<span style=color:#f92672>::</span>key<span style=color:#f92672>,</span> r <span style=color:#f92672>-&gt;</span> Utils<span style=color:#f92672>.</span><span style=color:#a6e22e>toJson</span><span style=color:#f92672>(</span>r<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>())));</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=maven-cli>maven & cli configuration <a hidden class=anchor aria-hidden=true href=#maven-cli>#</a></h3><p>To wrap-up we&rsquo;ll look at what is involved in getting the tests to run from an IDE and maven.</p><p>Running tests from IntelliJ or Eclipse involves using Cucumber&rsquo;s CLI. This is configured using the <code>cucumber.properties</code>
file. We&rsquo;ll use Surefire to run the tests from our Maven build which is instead configured with
<code>junit-platform.properties</code>.<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup> These two files are therefore identical & contain a single property ,
<code>cucumber.plugin=dev.codecrumbs.sales.test.Pipeline</code> which will ensure Cucumber uses our <code>Pipeline</code> plugin class.</p><p>For feature files to be found by the maven surefire plugin we also need a class annotated with <code>@Cucumber</code> in the <em>same</em>
package as the features. In our case this will be named <code>IntegrationTests</code>.</p><p>That&rsquo;s it! The tests will now run as part of the maven build or from an IDE. They look like this in IntelliJ:</p><p><img src=/post-images/intellij-cucumber.png alt="Cucumber in IntgelliJ"></p><hr><p><a href=https://github.com/codecrumbs-dev/cucumber-n-testcontainers>source</a>.<br><a href=https://github.com/codecrumbs-dev/order-enrichment-stream>system under test</a>.</p><p><a href=https://cucumber.io/tools/cucumber-open/>cucumber</a>.<br><a href=https://github.com/cucumber/cucumber-jvm>cucumber-jvm</a>.<br><a href=https://www.testcontainers.org/>testcontainers</a>.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>I am showing annotation-based step definitions here as I personally find them more readable than the lambda alternatives available as
part of <code>cucumber-java8</code>. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>I initially tried to start the applications under test in the same JVM as the tests & imported the applications via
maven dependencies but I had to abandon this approach as I did not want to restrict the applications to having the same
versions of common libraries. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>A <code>@BeforeAll</code> annotation will be added in <code>cucumber-jvm</code> v7 - see <a href=https://github.com/cucumber/cucumber-jvm/issues/515>this</a>
issue. <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>There may be other approaches that would use the CLI &, therefore, the same configuration file. <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.codecrumbs.dev/tags/testing/>testing</a></li><li><a href=https://www.codecrumbs.dev/tags/integration-testing/>integration-testing</a></li><li><a href=https://www.codecrumbs.dev/tags/cucumber/>cucumber</a></li><li><a href=https://www.codecrumbs.dev/tags/testcontainers/>testcontainers</a></li><li><a href=https://www.codecrumbs.dev/tags/bdd/>bdd</a></li><li><a href=https://www.codecrumbs.dev/tags/kafka/>kafka</a></li></ul></footer></article></main><footer class=footer><span>&#183;</span>
<span>&copy; 2021 <a href=https://www.codecrumbs.dev>codecrumbs</a></span>
<span>&#183;</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><script>window.onload=function(){if(localStorage.getItem("menu-scroll-position")){document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position");}}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});if(id==="top"){history.replaceState(null,null," ");}else{history.replaceState(null,null,`#${id}`);}});});var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft);}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>